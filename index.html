<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./icon-120.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./icon-16.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeScript Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: #2c3e50;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .header-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .header-button:active {
            background: rgba(255,255,255,0.3);
        }
        
        .content-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* PCÁâà„ÅÆ„Çπ„ÉØ„Ç§„Éë„Éº„É©„ÉÉ„Éë„Éº */
        .swiper-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        @media (min-width: 768px) {
            .swiper-wrapper {
                transform: none !important;
            }
        }
        
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #ddd;
            min-width: 250px;
            height: 100%;
        }
        
        .column:last-child {
            border-right: none;
        }
        
        .column-header {
            background: #34495e;
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .column-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .column-button:hover {
            background: #5a6268;
        }
        
        .main-editor-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .main-editor {
            width: 100%;
            min-height: calc(100% - 32px);
            border: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: transparent;
            outline: none;
        }
        
        .scenes-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
        }
        
        .scene-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #e8f0fe;
            cursor: pointer;
            user-select: none;
        }
        
        .scene-header:hover {
            background: #dde7f5;
        }
        
        .scene-label {
            font-weight: bold;
            color: #1a73e8;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .scene-toggle {
            transition: transform 0.3s;
            font-size: 12px;
        }
        
        .scene-toggle.open {
            transform: rotate(90deg);
        }
        
        .scene-actions {
            display: flex;
            gap: 8px;
        }
        
        .scene-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .scene-button.delete {
            background: #dc3545;
        }
        
        .scene-button.add-page {
            background: #17a2b8;
        }
        
        .scene-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .scene-content.open {
            max-height: 2000px;
        }
        
        .scene-text {
            padding: 16px;
            background: #f8f9fa;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        
        .scene-text:focus {
            outline: none;
            background: #f0f8ff;
        }
        
        .pages-container {
            padding: 0 16px 16px;
        }
        
        .page-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
        }
        
        .page-label {
            font-weight: 500;
            color: #5f6368;
        }
        
        .page-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .page-content {
            padding: 12px;
            min-height: 50px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        
        .page-content:focus {
            outline: none;
            background: #f0f8ff;
        }
        
        .dialogues-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
        }
        
        .dialogue-item {
            background: #fef7e0;
            border: 1px solid #f9ab00;
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px;
        }
        
        .dialogue-header {
            font-weight: 500;
            color: #f9ab00;
            margin-bottom: 8px;
        }
        
        .dialogue-text {
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 8px;
            font-style: italic;
            cursor: text;
            transition: background 0.2s;
        }
        
        .dialogue-text:hover {
            background: #f8f8f8;
        }
        
        .dialogue-text:focus {
            outline: none;
            background: #f0f8ff;
            box-shadow: 0 0 0 2px #1a73e8;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .undo-redo-buttons {
            display: flex;
            gap: 4px;
        }
        
        .undo-button, .redo-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .undo-button:disabled, .redo-button:disabled {
            opacity: 0.5;
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .app-header {
                display: flex;
            }
            
            .content-container {
                position: relative;
                overflow: hidden;
                flex: 1;
            }
            
            .swiper-wrapper {
                display: flex;
                height: 100%;
                transition: transform 0.3s ease-out;
                will-change: transform;
                width: 300%;
            }
            
            .column {
                width: 100%;
                height: 100%;
                flex-shrink: 0;
                border-right: none;
                min-width: auto;
                flex: none;
            }
            

            .column-header {
                display: flex; /* ÈùûË°®Á§∫„ÇíflexË°®Á§∫„Å´Â§âÊõ¥ */
                justify-content: space-between;
                align-items: center;
                padding: 8px; /* „É¢„Éê„Ç§„É´Áî®„ÅÆÂ∞è„Åï„ÇÅ„Éë„Éá„Ç£„É≥„Ç∞ */
                background: #34495e; /* ËÉåÊôØËâ≤„ÇíÁ∂≠ÊåÅ */
                color: white; /* ÊñáÂ≠óËâ≤„ÇíÁ∂≠ÊåÅ */
            }

            .column-button {
                font-size: 10px; /* „Éú„Çø„É≥„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂ∞è„Åï„ÇÅ„Å´Ë™øÊï¥ */
                padding: 4px 6px;
            }


            
            .scene-content.open {
                max-height: 1000px;
            }
            
            /* „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
            .page-indicators {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 8px;
                padding: 8px;
                background: rgba(0,0,0,0.3);
                border-radius: 20px;
                z-index: 5;
            }
            
            .indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: rgba(255,255,255,0.5);
                transition: background 0.3s;
            }
            
            .indicator.active {
                background: white;
            }
            
            /* „Çø„Éñ„Éê„Éº */
            .tab-bar {
                display: flex;
                background: white;
                border-top: 1px solid #ddd;
                flex-shrink: 0;
                box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
                z-index: 10;
            }
            
            .tab-item {
                flex: 1;
                padding: 12px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                cursor: pointer;
                transition: background 0.2s;
                position: relative;
            }
            
            .tab-item:active {
                background: #f0f0f0;
            }
            
            .tab-item.active::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: #1a73e8;
            }
            
            .tab-icon {
                font-size: 20px;
            }
            
            .tab-label {
                font-size: 11px;
                color: #666;
            }
            
            .tab-item.active .tab-label {
                color: #1a73e8;
            }
            
            .desktop-buttons {
                display: none !important;
            }
        }
        
        /* „Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú */
        @media (min-width: 769px) and (max-width: 1024px) {
            .column {
                min-width: 200px;
            }
        }
        
        /* „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Åß„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥ */
        @media (min-width: 768px) {
            .app-header {
                display: none;
            }
            
            .page-indicators {
                display: none !important;
            }
            
            .tab-bar {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="header-title">TreeScript Editor</div>
            <div class="header-buttons">
                <div class="undo-redo-buttons">
                    <button id="undoButton" class="undo-button" onclick="undo()">‚Ü∂</button>
                    <button id="redoButton" class="redo-button" onclick="redo()">‚Ü∑</button>
                </div>
                <button class="header-button" onclick="showFileMenu()">üìÅ</button>
            </div>
        </div>
        
        <div class="content-container" id="contentContainer">
            <div class="swiper-wrapper" id="swiperWrapper">
                <!-- Â∑¶„Ç´„É©„É†: „É°„Ç§„É≥„Ç®„Éá„Ç£„Çø -->
                <div class="column" data-page="0">
                    <div class="column-header">
                        <span>„É°„Ç§„É≥„Ç®„Éá„Ç£„Çø</span>
                        <div class="desktop-buttons">
                            <button class="column-button" onclick="newFile()">Êñ∞Ë¶è</button>
                            <button class="column-button" onclick="openFile()">Èñã„Åè</button>
                            <button class="column-button" onclick="saveFile()">‰øùÂ≠ò</button>
                        </div>
                    </div>
                    <div class="main-editor-container">
                        <textarea id="mainEditor" class="main-editor" placeholder="„Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ...

‰æã:
{„Ç∑„Éº„É≥: Êúù„ÅÆÊïôÂÆ§
ÁîüÂæí„Åü„Å°„ÅåÁôªÊ†°„Åó„Å¶„Åè„ÇãÊôÇÈñì„ÄÇ
[„Éö„Éº„Ç∏: 1„Éö„Éº„Ç∏ÁõÆ
„Äå„Åä„ÅØ„Çà„ÅÜÔºÅ„Äç
‰∏ª‰∫∫ÂÖ¨„ÅåÊïôÂÆ§„Å´ÂÖ•„Å£„Å¶„Åè„Çã„ÄÇ
]
[„Éö„Éº„Ç∏: 2„Éö„Éº„Ç∏ÁõÆ
„Äå‰ªäÊó•„ÇÇ‰∏ÄÊó•È†ëÂºµ„Çç„ÅÜ„Äç
ÊéàÊ•≠„ÅåÂßã„Åæ„Çã„ÄÇ
]
}

{„Ç∑„Éº„É≥: Êòº‰ºë„Åø
[„Éö„Éº„Ç∏: „ÅäÂºÅÂΩì„Çø„Ç§„É†
„Äå„ÅäËÖπ„Åô„ÅÑ„ÅüÔΩû„Äç
„Åø„Çì„Å™„Åß„ÅäÂºÅÂΩì„ÇíÈ£ü„Åπ„Çã„ÄÇ
]
}"></textarea>
                    </div>
                </div>
                
                <!-- ‰∏≠Â§Æ„Ç´„É©„É†: „Ç∑„Éº„É≥ÔºÜ„Éö„Éº„Ç∏ -->
                <div class="column" data-page="1">
                    <div class="column-header">
                        <span>„Ç∑„Éº„É≥ÔºÜ„Éö„Éº„Ç∏</span>
                        <button class="column-button" onclick="addScene()">+ „Ç∑„Éº„É≥ËøΩÂä†</button>
                    </div>
                    <div class="scenes-container" id="scenesContainer"></div>
                </div>
                
                <!-- Âè≥„Ç´„É©„É†: „Çª„É™„Éï -->
                <div class="column" data-page="2">
                    <div class="column-header">
                        <span>„Çª„É™„Éï</span>
                        <button class="column-button" onclick="exportDialogues()">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                    </div>
                    <div class="dialogues-container" id="dialoguesContainer"></div>
                </div>
            </div>
            
            <!-- „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
            <div class="page-indicators" id="pageIndicators" style="display: none;">
                <span class="indicator active"></span>
                <span class="indicator"></span>
                <span class="indicator"></span>
            </div>
        </div>
        
        <!-- „Çø„Éñ„Éê„ÉºÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
        <div class="tab-bar" id="tabBar" style="display: none;">
            <div class="tab-item active" data-page="0" onclick="switchToPage(0)">
                <span class="tab-icon">üìù</span>
                <span class="tab-label">„É°„Ç§„É≥</span>
            </div>
            <div class="tab-item" data-page="1" onclick="switchToPage(1)">
                <span class="tab-icon">üé¨</span>
                <span class="tab-label">„Ç∑„Éº„É≥</span>
            </div>
            <div class="tab-item" data-page="2" onclick="switchToPage(2)">
                <span class="tab-icon">üí¨</span>
                <span class="tab-label">„Çª„É™„Éï</span>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentPage = 0;
        let data = {
            scenes: [],
            pages: [],
            dialogues: []
        };
        
        // DOMË¶ÅÁ¥†
        let mainEditor;
        let scenesContainer;
        let dialoguesContainer;
        let undoButton;
        let redoButton;
        let swiperWrapper;
        let pageIndicators;
        let tabBar;
        
        // Â±•Ê≠¥ÁÆ°ÁêÜ
        let history = [];
        let historyIndex = -1;
        const maxHistory = 50;
        let isUpdatingFromHistory = false;
        
        // ÁèæÂú®Èñã„ÅÑ„Å¶„ÅÑ„Çã„Ç∑„Éº„É≥
        let currentOpenScene = null;
        
        // „Çπ„ÉØ„Ç§„ÉóÂà∂Âæ°
        let touchStartX = 0;
        let touchEndX = 0;
        let isSwiping = false;
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÅÆ„Ç≠„Éº
        const STORAGE_KEY = 'treescript_data';
        const STORAGE_HISTORY_KEY = 'treescript_history';
        const STORAGE_HISTORY_INDEX_KEY = 'treescript_history_index';
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
            mainEditor = document.getElementById('mainEditor');
            scenesContainer = document.getElementById('scenesContainer');
            dialoguesContainer = document.getElementById('dialoguesContainer');
            undoButton = document.getElementById('undoButton');
            redoButton = document.getElementById('redoButton');
            swiperWrapper = document.getElementById('swiperWrapper');
            pageIndicators = document.getElementById('pageIndicators');
            tabBar = document.getElementById('tabBar');
            
            // „É¢„Éê„Ç§„É´ÂØæÂøú„ÅÆÂàùÊúüÂåñ
            updateMobileLayout();
            window.addEventListener('resize', updateMobileLayout);
            
            // „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ
            loadFromStorage();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners();
            
            // ÂàùÊúüË°®Á§∫
            updateUI();
        });
        
        // „É¢„Éê„Ç§„É´„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÊõ¥Êñ∞
        let swipeEventsAdded = false;

        function updateMobileLayout() {
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                pageIndicators.style.display = 'flex';
                tabBar.style.display = 'flex';
                swiperWrapper.style.display = 'flex';
                swiperWrapper.style.transform = `translateX(-${currentPage * 100}%)`;
                document.querySelector('.app-header').style.display = 'flex';

                document.querySelectorAll('.desktop-buttons').forEach(btn => {
                    btn.style.display = 'none';
                });

                if (!swipeEventsAdded) {
                    swiperWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
                    swiperWrapper.addEventListener('touchmove', handleTouchMove, { passive: true });
                    swiperWrapper.addEventListener('touchend', handleTouchEnd);
                    swipeEventsAdded = true;
                }

            } else {
                pageIndicators.style.display = 'none';
                tabBar.style.display = 'none';
                swiperWrapper.style.display = 'flex';
                swiperWrapper.style.transform = 'none';
                document.querySelector('.app-header').style.display = 'none';

                document.querySelectorAll('.desktop-buttons').forEach(btn => {
                    btn.style.display = 'flex';
                });

                if (swipeEventsAdded) {
                    swiperWrapper.removeEventListener('touchstart', handleTouchStart);
                    swiperWrapper.removeEventListener('touchmove', handleTouchMove);
                    swiperWrapper.removeEventListener('touchend', handleTouchEnd);
                    swipeEventsAdded = false;
                }
            }
        }

        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadFromStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                const savedHistory = localStorage.getItem(STORAGE_HISTORY_KEY);
                const savedHistoryIndex = localStorage.getItem(STORAGE_HISTORY_INDEX_KEY);
                
                if (savedData) {
                    mainEditor.value = savedData;
                }
                
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                    historyIndex = savedHistoryIndex ? parseInt(savedHistoryIndex) : history.length - 1;
                } else {
                    history = [mainEditor.value];
                    historyIndex = 0;
                }
                
                updateUndoRedoButtons();
            } catch (e) {
                console.error('Failed to load from storage:', e);
                history = [mainEditor.value];
                historyIndex = 0;
            }
        }
        
        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, mainEditor.value);
                localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(history));
                localStorage.setItem(STORAGE_HISTORY_INDEX_KEY, historyIndex.toString());
            } catch (e) {
                console.error('Failed to save to storage:', e);
            }
        }
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„ÅÆ„Ç§„Éô„É≥„Éà
            let inputTimer = null;
            mainEditor.addEventListener('input', (e) => {
                updateUI();
                clearTimeout(inputTimer);
                inputTimer = setTimeout(() => {
                    addToHistory({
                        type: 'text',
                        content: mainEditor.value
                    });
                }, 500);
            });
            
            // „Çπ„ÉØ„Ç§„Éó„Ç§„Éô„É≥„ÉàÔºà„É¢„Éê„Ç§„É´„ÅÆ„ÅøÔºâ
            if (window.innerWidth < 768) {
                swiperWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
                swiperWrapper.addEventListener('touchmove', handleTouchMove, { passive: true });
                swiperWrapper.addEventListener('touchend', handleTouchEnd);
            }
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    redo();
                }
            });
        }
        
        // „Çπ„ÉØ„Ç§„Éó„Éè„É≥„Éâ„É©„Éº
        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            isSwiping = false;
        }
        
        function handleTouchMove(e) {
            if (!touchStartX) return;
            
            const touchX = e.touches[0].clientX;
            const diffX = touchX - touchStartX;
            
            if (Math.abs(diffX) > 10) {
                isSwiping = true;
            }
        }
        
        function handleTouchEnd(e) {
            if (!isSwiping) return;
            
            touchEndX = e.changedTouches[0].clientX;
            const diffX = touchEndX - touchStartX;
            
            // „Çπ„ÉØ„Ç§„Éó„ÅÆÂà§ÂÆöÔºà50px‰ª•‰∏ä„ÅßÂàá„ÇäÊõø„ÅàÔºâ
            if (Math.abs(diffX) > 50) {
                if (diffX > 0 && currentPage > 0) {
                    // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆ„Éö„Éº„Ç∏„Å∏Ôºâ
                    switchToPage(currentPage - 1);
                } else if (diffX < 0 && currentPage < 2) {
                    // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å∏Ôºâ
                    switchToPage(currentPage + 1);
                }
            }
            
            touchStartX = 0;
            touchEndX = 0;
            isSwiping = false;
        }
        
        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function switchToPage(pageIndex) {
            currentPage = pageIndex;
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                const offset = pageIndex * 100;
                swiperWrapper.style.transform = `translateX(-${offset}%)`;
            }

            updatePageIndicators();
            updateTabBar();
        }


        
        // „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆÊõ¥Êñ∞
        function updatePageIndicators() {
            const indicators = pageIndicators.querySelectorAll('.indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === currentPage);
            });
        }
        
        // „Çø„Éñ„Éê„Éº„ÅÆÊõ¥Êñ∞
        function updateTabBar() {
            const tabs = tabBar.querySelectorAll('.tab-item');
            tabs.forEach((tab, index) => {
                tab.classList.toggle('active', index === currentPage);
            });
        }
        
        // „Éï„Ç°„Ç§„É´„É°„Éã„É•„Éº„ÅÆË°®Á§∫
        function showFileMenu() {
            const menu = `
1. Êñ∞Ë¶è‰ΩúÊàê
2. „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè
3. ‰øùÂ≠ò
4. „Çª„É™„Éï„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà

ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`;
            
            const choice = prompt(menu);
            
            switch (choice) {
                case '1':
                    newFile();
                    break;
                case '2':
                    openFile();
                    break;
                case '3':
                    saveFile();
                    break;
                case '4':
                    exportDialogues();
                    break;
            }
        }
        
        // Â±•Ê≠¥ÁÆ°ÁêÜ
        function addToHistory(action) {
            if (isUpdatingFromHistory) return;
            
            history = history.slice(0, historyIndex + 1);
            history.push(action);
            
            if (history.length > maxHistory) {
                history.shift();
            }
            
            historyIndex = history.length - 1;
            updateUndoRedoButtons();
            saveToStorage();
        }
        
        function updateUndoRedoButtons() {
            undoButton.disabled = historyIndex <= 0;
            redoButton.disabled = historyIndex >= history.length - 1;
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                isUpdatingFromHistory = true;
                applyHistoryAction(history[historyIndex]);
                isUpdatingFromHistory = false;
                updateUndoRedoButtons();
                saveToStorage();
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                isUpdatingFromHistory = true;
                applyHistoryAction(history[historyIndex]);
                isUpdatingFromHistory = false;
                updateUndoRedoButtons();
                saveToStorage();
            }
        }
        
        function applyHistoryAction(action) {
            if (typeof action === 'string') {
                // ÊóßÂΩ¢Âºè„ÅÆÂ±•Ê≠¥ÔºàÊñáÂ≠óÂàó„ÅÆ„ÅøÔºâ„Å®„ÅÆ‰∫íÊèõÊÄß
                mainEditor.value = action;
            } else if (action.type === 'text') {
                mainEditor.value = action.content;
            }
            updateUI();
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Éë„Éº„Çπ
        function parseText(text) {
            const newData = {
                scenes: [],
                pages: [],
                dialogues: []
            };
            
            const sceneRegex = /\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g;
            let sceneMatch;
            let sceneIndex = 0;
            let globalPageNumber = 1;
            
            while ((sceneMatch = sceneRegex.exec(text)) !== null) {
                const sceneContent = sceneMatch[1];
                const sceneId = `scene-${sceneIndex}`;
                
                const sceneData = {
                    id: sceneId,
                    content: sceneContent,
                    fullMatch: sceneMatch[0],
                    startIndex: sceneMatch.index,
                    endIndex: sceneMatch.index + sceneMatch[0].length,
                    pages: []
                };
                
                const pageRegex = /\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g;
                let pageMatch;
                
                while ((pageMatch = pageRegex.exec(sceneContent)) !== null) {
                    const pageContent = pageMatch[1];
                    const pageId = `page-${sceneIndex}-${sceneData.pages.length}`;
                    
                    const dialogues = [];
                    const dialogueRegex = /„Äå([^„Äç]*)„Äç/g;
                    let dialogueMatch;
                    
                    while ((dialogueMatch = dialogueRegex.exec(pageContent)) !== null) {
                        dialogues.push(dialogueMatch[1]);
                    }
                    
                    const page = {
                        id: pageId,
                        content: pageContent,
                        sceneId: sceneId,
                        sceneIndex: sceneIndex,
                        dialogues: dialogues,
                        pageNumber: globalPageNumber++
                    };
                    
                    newData.pages.push(page);
                    sceneData.pages.push(page);
                    
                    newData.dialogues.push({
                        pageId: pageId,
                        sceneId: sceneId,
                        texts: dialogues,
                        pageNumber: page.pageNumber
                    });
                }
                
                newData.scenes.push(sceneData);
                sceneIndex++;
            }
            
            return newData;
        }
        
        // UIÊõ¥Êñ∞
        function updateUI() {
            // ÁèæÂú®Èñã„ÅÑ„Å¶„ÅÑ„Çã„Ç∑„Éº„É≥„ÅÆID„Çí‰øùÂ≠ò
            const openScenes = [];
            document.querySelectorAll('.scene-content.open').forEach(content => {
                const sceneItem = content.closest('.scene-item');
                if (sceneItem && sceneItem.dataset.sceneId) {
                    openScenes.push(sceneItem.dataset.sceneId);
                }
            });
            
            const text = mainEditor.value;
            data = parseText(text);
            
            updateScenes();
            updateDialogues();
            saveToStorage();
            
            // Èñã„ÅÑ„Å¶„ÅÑ„Åü„Ç∑„Éº„É≥„ÇíÂæ©ÂÖÉ
            openScenes.forEach(sceneId => {
                const sceneItem = document.querySelector(`[data-scene-id="${sceneId}"]`);
                if (sceneItem) {
                    const sceneContent = sceneItem.querySelector('.scene-content');
                    const toggle = sceneItem.querySelector('.scene-toggle');
                    if (sceneContent && toggle) {
                        sceneContent.classList.add('open');
                        toggle.classList.add('open');
                    }
                }
            });
        }
        
        // „Ç∑„Éº„É≥„ÅÆÊõ¥Êñ∞
        function updateScenes() {
            // ÁèæÂú®Èñã„ÅÑ„Å¶„ÅÑ„Çã„Ç∑„Éº„É≥„ÅÆID„ÇíÂèñÂæó
            const openScenes = [];
            document.querySelectorAll('.scene-content.open').forEach(content => {
                const sceneItem = content.closest('.scene-item');
                if (sceneItem && sceneItem.dataset.sceneId) {
                    openScenes.push(sceneItem.dataset.sceneId);
                }
            });
            
            scenesContainer.innerHTML = '';
            
            if (data.scenes.length === 0) {
                scenesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üé¨</div>
                        <div>„Ç∑„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">„Äå+ „Ç∑„Éº„É≥ËøΩÂä†„Äç„Éú„Çø„É≥„ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            data.scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                sceneItem.dataset.sceneId = scene.id;
                
                const isOpen = openScenes.includes(scene.id);  // ‚Üê „Åì„Åì„ÅåÂ§âÊõ¥ÁÇπ
                
                sceneItem.innerHTML = `
                    <div class="scene-header" onclick="toggleScene('${scene.id}')">
                        <span class="scene-label">
                            <span class="scene-toggle ${isOpen ? 'open' : ''}">‚ñ∂</span>
                            „Ç∑„Éº„É≥ ${index + 1}
                        </span>
                        <div class="scene-actions">
                            <button class="scene-button add-page" onclick="event.stopPropagation(); addPageToScene('${scene.id}', ${index})">+ „Éö„Éº„Ç∏</button>
                            <button class="scene-button delete" onclick="event.stopPropagation(); deleteScene(${index})">ÂâäÈô§</button>
                        </div>
                    </div>
                    <div class="scene-content ${isOpen ? 'open' : ''}">
                        <div class="scene-text" contenteditable="true" data-index="${index}" data-type="scene">${escapeHtml(getSceneDescription(scene.content)).replace(/\n/g, '<br>')}</div>
                        <div class="pages-container" id="pages-${scene.id}"></div>
                    </div>
                `;
                
                scenesContainer.appendChild(sceneItem);
                
                // „Ç∑„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÁ∑®ÈõÜ„Ç§„Éô„É≥„Éà
                const sceneText = sceneItem.querySelector('.scene-text');
                setupContentEditable(sceneText, index, 'scene');
                
                // „Éö„Éº„Ç∏„ÅÆË°®Á§∫
                const pagesContainer = sceneItem.querySelector(`#pages-${scene.id}`);
                updatePagesInScene(pagesContainer, scene.pages);
            });
        }
        
        // „Ç∑„Éº„É≥„ÅÆË™¨ÊòéÈÉ®ÂàÜ„ÅÆ„Åø„ÇíÂèñÂæó
        function getSceneDescription(content) {
            const pageRegex = /\[„Éö„Éº„Ç∏:[\s\S]*?\]/g;
            return content.replace(pageRegex, '').trim();
        }
        
        // „Ç∑„Éº„É≥ÂÜÖ„ÅÆ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞
        function updatePagesInScene(container, pages) {
            container.innerHTML = '';
            
            pages.forEach((page, index) => {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item';
                
                pageItem.innerHTML = `
                    <div class="page-header">
                        <span class="page-label">„Éö„Éº„Ç∏ ${page.pageNumber}</span>
                        <button class="page-delete" onclick="deletePage(${data.pages.indexOf(page)})">ÂâäÈô§</button>
                    </div>
                    <div class="page-content" contenteditable="true" data-index="${data.pages.indexOf(page)}" data-type="page">${escapeHtml(page.content).replace(/\n/g, '<br>')}</div>
                `;
                
                container.appendChild(pageItem);
                
                // „Éö„Éº„Ç∏Á∑®ÈõÜ„Ç§„Éô„É≥„Éà
                const pageContent = pageItem.querySelector('.page-content');
                setupContentEditable(pageContent, data.pages.indexOf(page), 'page');
            });
        }
        

        // „Ç∑„Éº„É≥„ÅÆÈñãÈñâÂàá„ÇäÊõø„Åà
        function toggleScene(sceneId) {
            const sceneItem = document.querySelector(`[data-scene-id="${sceneId}"]`);
            const sceneContent = sceneItem.querySelector('.scene-content');
            const toggle = sceneItem.querySelector('.scene-toggle');
            
            // ÈñãÈñâÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà„Çã
            if (sceneContent.classList.contains('open')) {
                // Èñâ„Åò„Çã
                sceneContent.classList.remove('open');
                toggle.classList.remove('open');
            } else {
                // Èñã„Åè
                sceneContent.classList.add('open');
                toggle.classList.add('open');
            }
        }
        
        // „Çª„É™„Éï„ÅÆÊõ¥Êñ∞
        function updateDialogues() {
            dialoguesContainer.innerHTML = '';
            
            if (data.dialogues.length === 0 || data.dialogues.every(d => d.texts.length === 0)) {
                dialoguesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div>„Çª„É™„Éï„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">„Éö„Éº„Ç∏„Å´„Äå„Äç„Åß„Çª„É™„Éï„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            data.dialogues.forEach((dialogueGroup, groupIndex) => {
                if (dialogueGroup.texts.length === 0) return;
                
                const dialogueItem = document.createElement('div');
                dialogueItem.className = 'dialogue-item';
                
                const dialogueTexts = dialogueGroup.texts.map((text, textIndex) => 
                    `<div class="dialogue-text" contenteditable="true" data-group="${groupIndex}" data-text="${textIndex}">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`
                ).join('');
                
                dialogueItem.innerHTML = `
                    <div class="dialogue-header">„Éö„Éº„Ç∏ ${dialogueGroup.pageNumber}</div>
                    ${dialogueTexts}
                `;
                
                dialoguesContainer.appendChild(dialogueItem);
                
                // ÂêÑ„Çª„É™„Éï„ÉÜ„Ç≠„Çπ„Éà„Å´Á∑®ÈõÜ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
                dialogueItem.querySelectorAll('.dialogue-text').forEach((textElement) => {
                    setupDialogueEditable(textElement);
                });
            });
        }
        
        // „Ç≥„É≥„ÉÜ„É≥„ÉÑÁ∑®ÈõÜÂèØËÉΩË¶ÅÁ¥†„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        function setupContentEditable(element, index, type) {
            let isComposing = false;
            
            element.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            element.addEventListener('compositionend', () => {
                isComposing = false;
            });
            
            element.addEventListener('input', (e) => {
                if (!isComposing) {
                    const newContent = htmlToText(e.target.innerHTML);
                    if (type === 'scene') {
                        updateSceneContent(index, newContent, false);
                    } else if (type === 'page') {
                        updatePageContent(index, newContent, false);
                    }
                }
            });
            
            element.addEventListener('blur', (e) => {
                const newContent = htmlToText(e.target.innerHTML);
                if (type === 'scene') {
                    updateSceneContent(index, newContent, true);
                } else if (type === 'page') {
                    updatePageContent(index, newContent, true);
                }
                addToHistory({
                    type: 'text',
                    content: mainEditor.value
                });
            });
            
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.execCommand('insertLineBreak');
                }
            });
        }
        
        // „Ç∑„Éº„É≥ÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
        function updateSceneContent(index, newContent, shouldUpdateUI = true) {
            const text = mainEditor.value;
            const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
            
            if (scenes[index]) {
                const oldScene = scenes[index][0];
                const oldContent = scenes[index][1];
                
                // „Éö„Éº„Ç∏ÈÉ®ÂàÜ„Çí‰øùÊåÅ
                const pageMatches = [...oldContent.matchAll(/\[„Éö„Éº„Ç∏:[\s\S]*?\]/g)];
                const pagesText = pageMatches.map(m => m[0]).join('\n');
                
                // Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥ÂÜÖÂÆπ„ÇíÊßãÁØâ
                const newSceneContent = newContent + (pagesText ? '\n' + pagesText : '');
                const newScene = `{„Ç∑„Éº„É≥: ${newSceneContent}}`;
                
                mainEditor.value = text.replace(oldScene, newScene);
                if (shouldUpdateUI) {
                    updateUI();
                }
            }
        }
        
        // „Éö„Éº„Ç∏ÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
        function updatePageContent(index, newContent, shouldUpdateUI = true) {
            const text = mainEditor.value;
            const allPages = [...text.matchAll(/\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g)];
            
            let pageCount = 0;
            for (let match of allPages) {
                if (pageCount === index) {
                    const oldPage = match[0];
                    const newPage = `[„Éö„Éº„Ç∏: ${newContent}]`;
                    
                    mainEditor.value = text.replace(oldPage, newPage);
                    if (shouldUpdateUI) {
                        updateUI();
                    }
                    break;
                }
                pageCount++;
            }
        }
        
        // „Ç∑„Éº„É≥„ÅÆÂâäÈô§
        function deleteScene(index) {
            if (confirm('„Åì„ÅÆ„Ç∑„Éº„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const text = mainEditor.value;
                const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
                
                if (scenes[index]) {
                    mainEditor.value = text.replace(scenes[index][0], '');
                    updateUI();
                    addToHistory({
                        type: 'text',
                        content: mainEditor.value
                    });
                }
            }
        }
        
        // „Éö„Éº„Ç∏„ÅÆÂâäÈô§
        function deletePage(index) {
            if (confirm('„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const text = mainEditor.value;
                const allPages = [...text.matchAll(/\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g)];
                
                let pageCount = 0;
                for (let match of allPages) {
                    if (pageCount === index) {
                        mainEditor.value = text.replace(match[0], '');
                        break;
                    }
                    pageCount++;
                }
                updateUI();
                addToHistory({
                    type: 'text',
                    content: mainEditor.value
                });
            }
        }
        
        // „Ç∑„Éº„É≥„ÅÆËøΩÂä†
        function addScene() {
            const newScene = '\n\n{„Ç∑„Éº„É≥: Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥\n[„Éö„Éº„Ç∏: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏\n„Äå„Çª„É™„Éï„Äç\n]\n}';
            mainEditor.value += newScene;
            updateUI();
            addToHistory({
                type: 'text',
                content: mainEditor.value
            });
        }
        
        // ÁâπÂÆö„ÅÆ„Ç∑„Éº„É≥„Å´„Éö„Éº„Ç∏„ÇíËøΩÂä†
        function addPageToScene(sceneId, sceneIndex) {
            const text = mainEditor.value;
            const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
            
            if (scenes[sceneIndex]) {
                const sceneMatch = scenes[sceneIndex];
                const sceneContent = sceneMatch[0];
                const newPage = '\n[„Éö„Éº„Ç∏: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏\n„Äå„Çª„É™„Éï„Äç\n]';
                const newSceneContent = sceneContent.replace(/\}$/, newPage + '\n}');
                
                mainEditor.value = text.replace(sceneContent, newSceneContent);
                updateUI();
                addToHistory({
                    type: 'text',
                    content: mainEditor.value
                });
            }
        }
        
        // „Çª„É™„Éï„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportDialogues() {
            const allDialogues = [];
            data.dialogues.forEach(group => {
                if (group.texts.length > 0) {
                    // „Éö„Éº„Ç∏Áï™Âè∑„Çí„Ç≥„É°„É≥„Éà„Å®„Åó„Å¶ËøΩÂä†ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
                    // allDialogues.push(`--- „Éö„Éº„Ç∏ ${group.pageNumber} ---`);
                    
                    // ÂêÑ„Çª„É™„Éï„Çí‰∏ÄË°åÁ©∫„Åë„ÅßËøΩÂä†
                    group.texts.forEach((text, index) => {
                        allDialogues.push(text);
                        // ÊúÄÂæå„ÅÆ„Çª„É™„Éï‰ª•Â§ñ„ÅØÁ©∫Ë°å„ÇíËøΩÂä†
                        if (index < group.texts.length - 1) {
                            allDialogues.push('');
                        }
                    });
                    
                    // „Ç∞„É´„Éº„ÉóÈñì„Å´„ÇÇÁ©∫Ë°å„ÇíËøΩÂä†
                    allDialogues.push('');
                }
            });
            
            // ÊúÄÂæå„ÅÆ‰ΩôÂàÜ„Å™Á©∫Ë°å„ÇíÂâäÈô§
            if (allDialogues[allDialogues.length - 1] === '') {
                allDialogues.pop();
            }
            
            const dialogueText = allDialogues.join('\n');
            const blob = new Blob([dialogueText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dialogues.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // „Çª„É™„ÉïÁ∑®ÈõÜÂèØËÉΩË¶ÅÁ¥†„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        function setupDialogueEditable(element) {
            let isComposing = false;
            
            element.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            element.addEventListener('compositionend', () => {
                isComposing = false;
            });
            
            element.addEventListener('input', (e) => {
                if (!isComposing) {
                    const groupIndex = parseInt(e.target.dataset.group);
                    const textIndex = parseInt(e.target.dataset.text);
                    const newContent = htmlToText(e.target.innerHTML);
                    updateDialogueContent(groupIndex, textIndex, newContent, false);
                }
            });
            
            element.addEventListener('blur', (e) => {
                const groupIndex = parseInt(e.target.dataset.group);
                const textIndex = parseInt(e.target.dataset.text);
                const newContent = htmlToText(e.target.innerHTML);
                updateDialogueContent(groupIndex, textIndex, newContent, true);
                addToHistory({
                    type: 'text',
                    content: mainEditor.value
                });
            });
            
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.execCommand('insertLineBreak');
                }
            });
        }
        
        // „Çª„É™„ÉïÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
        function updateDialogueContent(groupIndex, textIndex, newContent, shouldUpdateUI = true) {
            const dialogueGroup = data.dialogues[groupIndex];
            if (!dialogueGroup) return;
            
            const pageData = data.pages.find(p => p.id === dialogueGroup.pageId);
            if (!pageData) return;
            
            // „É°„Ç§„É≥„Ç®„Éá„Ç£„Çø„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
            const text = mainEditor.value;
            const oldDialogue = `„Äå${dialogueGroup.texts[textIndex]}„Äç`;
            const newDialogue = `„Äå${newContent}„Äç`;
            
            // „Åô„Åπ„Å¶„ÅÆ„Çª„É™„Éï„ÇíÊ§úÁ¥¢„Åó„ÄÅÊ≠£„Åó„ÅÑ„ÇÇ„ÅÆ„ÇíÊõ¥Êñ∞
            let dialogueCount = 0;
            let targetDialogueIndex = 0;
            
            // ÂØæË±°„ÅÆ„Çª„É™„Éï„ÅåÂÖ®‰Ωì„Åß‰ΩïÁï™ÁõÆ„Åã„ÇíË®àÁÆó
            for (let i = 0; i < groupIndex; i++) {
                targetDialogueIndex += data.dialogues[i].texts.length;
            }
            targetDialogueIndex += textIndex;
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂÜÖ„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Çª„É™„Éï„ÇíÁΩÆÊèõ
            const updatedText = text.replace(/„Äå([^„Äç]*)„Äç/g, (match, content) => {
                if (dialogueCount === targetDialogueIndex) {
                    dialogueCount++;
                    return newDialogue;
                }
                dialogueCount++;
                return match;
            });
            
            mainEditor.value = updatedText;
            if (shouldUpdateUI) {
                updateUI();
            }
        }
        
        // „Éï„Ç°„Ç§„É´Êìç‰Ωú
        let currentFileName = null;
        
        function newFile() {
            if (mainEditor.value && !confirm('ÁèæÂú®„ÅÆÂÜÖÂÆπ„ÇíÁ†¥Ê£Ñ„Åó„Å¶Êñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            mainEditor.value = '';
            currentFileName = null;
            history = [''];
            historyIndex = 0;
            currentOpenScene = null;
            updateUI();
            updateUndoRedoButtons();
        }
        
        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        mainEditor.value = e.target.result;
                        currentFileName = file.name;
                        history = [{type: 'text', content: e.target.result}];
                        historyIndex = 0;
                        currentOpenScene = null;
                        updateUI();
                        updateUndoRedoButtons();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function saveFile() {
            const defaultName = currentFileName || 'treescript-document.txt';
            const fileName = prompt('„Éï„Ç°„Ç§„É´Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', defaultName);
            
            if (fileName) {
                const finalFileName = fileName.endsWith('.txt') ? fileName : fileName + '.txt';
                
                const text = mainEditor.value;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFileName;
                a.click();
                URL.revokeObjectURL(url);
                
                currentFileName = finalFileName;
            }
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function htmlToText(html) {
            let text = html.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<[^>]*>/g, '');
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        // Service WorkerÁôªÈå≤
        try {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(reg => console.log('SW registered'))
                        .catch(err => console.log('SW registration failed:', err));
                });
            }
        } catch (error) {
            console.log('Service Worker is not available in this environment:', error);
        }
    </script>
</body>
</html>