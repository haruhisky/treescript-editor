<!DOCTYPE html>
<html lang="ja">
<head>

    <!-- <head>„Çø„Ç∞ÂÜÖ„Å´ËøΩÂä† -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TreeScript Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            touch-action: pan-y;
        }
        
        /* „É¢„Éê„Ç§„É´/„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº */
        .app-header {
            background: #2c3e50;
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
        }
        
        .header-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .header-button:active {
            background: rgba(255,255,255,0.3);
        }
        
        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .content-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* „Çπ„ÉØ„Ç§„ÉóÂèØËÉΩ„Å™„Éö„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä */
        .swiper-container {
            display: flex;
            height: 100%;
            transition: transform 0.3s ease-out;
            will-change: transform;
        }
        
        .page {
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        /* „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
        .page-indicators {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            z-index: 5;
        }
        
        .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transition: background 0.3s;
        }
        
        .indicator.active {
            background: white;
        }
        
        /* „Çø„Éñ„Éê„Éº */
        .tab-bar {
            display: flex;
            background: white;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .tab-item {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .tab-item:active {
            background: #f0f0f0;
        }
        
        .tab-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #1a73e8;
        }
        
        .tab-icon {
            font-size: 20px;
        }
        
        .tab-label {
            font-size: 11px;
            color: #666;
        }
        
        .tab-item.active .tab-label {
            color: #1a73e8;
        }
        
        /* „É°„Ç§„É≥„Ç®„Éá„Ç£„Çø */
        .main-editor-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .main-editor {
            width: 100%;
            min-height: 100%;
            border: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: transparent;
        }
        
        /* „É™„Çπ„Éà„Ç≥„É≥„ÉÜ„Éä */
        .list-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 80px;
        }
        
        /* „Ç¢„Ç§„ÉÜ„É†„Çπ„Çø„Ç§„É´ */
        .list-item {
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s;
        }
        
        .list-item:active {
            transform: scale(0.98);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
        }
        
        .item-label {
            font-weight: bold;
            color: #333;
        }
        
        .item-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .item-content {
            padding: 16px;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        
        .item-content:focus {
            outline: none;
            background: #f0f8ff;
        }
        
        /* „Ç∑„Éº„É≥„Ç¢„Ç§„ÉÜ„É† */
        .scene-item .item-header {
            background: #e8f0fe;
        }
        
        .scene-item .item-label {
            color: #1a73e8;
        }
        
        /* „Éö„Éº„Ç∏„Ç¢„Ç§„ÉÜ„É† */
        .page-item .item-header {
            background: #f8f9fa;
        }
        
        .page-item .item-label {
            color: #5f6368;
        }
        
        /* „Çª„É™„Éï„Ç¢„Ç§„ÉÜ„É† */
        .dialogue-item {
            background: #fef7e0;
            border: 1px solid #f9ab00;
        }
        
        .dialogue-text {
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 8px;
            font-style: italic;
        }
        
        /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 20;
        }
        
        .fab:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* Desktop styles */
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .app-header {
                display: none;
            }
            
            .content-container {
                display: flex;
                flex: 1;
            }
            
            .swiper-container {
                display: flex;
                transition: none;
                transform: none !important;
            }
            
            .page {
                width: 25%;
                border-right: 1px solid #ddd;
            }
            
            .page:last-child {
                border-right: none;
            }
            
            .page-header {
                background: #2c3e50;
                color: white;
                padding: 12px 16px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .page-indicators {
                display: none;
            }
            
            .tab-bar {
                display: none;
            }
            
            .fab {
                display: none;
            }
            
            .list-container {
                padding-bottom: 16px;
            }
            
            .desktop-buttons {
                display: flex;
                gap: 8px;
            }
            
            .desktop-button {
                background: #6c757d;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .desktop-button:hover {
                background: #5a6268;
            }
        }
        
        /* Mobile specific */
        @media (max-width: 767px) {
            .page-header {
                display: none;
            }
            
            .desktop-buttons {
                display: none;
            }
        }
        
        /* Undo/Redo buttons */
        .undo-redo-buttons {
            display: flex;
            gap: 4px;
        }
        
        .undo-button, .redo-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .undo-button:disabled, .redo-button:disabled {
            opacity: 0.5;
        }
    </style>
</head>
<!-- </body>„ÅÆÁõ¥Ââç„Å´ËøΩÂä† -->
<script>
// Service WorkerÁôªÈå≤
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registered'))
      .catch(err => console.log('SW registration failed'));
  });
}
</script>
<body>
    <div class="app-container">
        <!-- „É¢„Éê„Ç§„É´„Éò„ÉÉ„ÉÄ„Éº -->
        <div class="app-header">
            <div class="header-title">TreeScript Editor</div>
            <div class="header-buttons">
                <div class="undo-redo-buttons">
                    <button id="undoButton" class="undo-button" onclick="undo()">‚Ü∂</button>
                    <button id="redoButton" class="redo-button" onclick="redo()">‚Ü∑</button>
                </div>
                <button class="header-button" onclick="showFileMenu()">üìÅ</button>
            </div>
        </div>
        
        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="content-container">
            <div class="swiper-container" id="swiperContainer">
                <!-- „É°„Ç§„É≥„Çø„Éñ -->
                <div class="page" data-page="0">
                    <div class="page-header">
                        <span>„É°„Ç§„É≥„Çø„Éñ</span>
                        <div class="desktop-buttons">
                            <div class="undo-redo-buttons">
                                <button class="undo-button" onclick="undo()">‚Ü∂</button>
                                <button class="redo-button" onclick="redo()">‚Ü∑</button>
                            </div>
                            <button onclick="newFile()" class="desktop-button">Êñ∞Ë¶è‰ΩúÊàê</button>
                            <button onclick="openFile()" class="desktop-button">Èñã„Åè</button>
                            <button onclick="saveFile()" class="desktop-button">‰øùÂ≠ò</button>
                        </div>
                    </div>
                    <div class="main-editor-container">
                        <textarea id="mainEditor" class="main-editor" placeholder="„Åì„Åì„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ...

‰æã:
{„Ç∑„Éº„É≥: Êúù„ÅÆÊïôÂÆ§
ÁîüÂæí„Åü„Å°„ÅåÁôªÊ†°„Åó„Å¶„Åè„ÇãÊôÇÈñì„ÄÇ
[„Éö„Éº„Ç∏: 1„Éö„Éº„Ç∏ÁõÆ
„Äå„Åä„ÅØ„Çà„ÅÜÔºÅ„Äç
‰∏ª‰∫∫ÂÖ¨„ÅåÊïôÂÆ§„Å´ÂÖ•„Å£„Å¶„Åè„Çã„ÄÇ
]
[„Éö„Éº„Ç∏: 2„Éö„Éº„Ç∏ÁõÆ
„Äå‰ªäÊó•„ÇÇ‰∏ÄÊó•È†ëÂºµ„Çç„ÅÜ„Äç
ÊéàÊ•≠„ÅåÂßã„Åæ„Çã„ÄÇ
]
}

{„Ç∑„Éº„É≥: Êòº‰ºë„Åø
[„Éö„Éº„Ç∏: „ÅäÂºÅÂΩì„Çø„Ç§„É†
„Äå„ÅäËÖπ„Åô„ÅÑ„ÅüÔΩû„Äç
„Åø„Çì„Å™„Åß„ÅäÂºÅÂΩì„ÇíÈ£ü„Åπ„Çã„ÄÇ
]
}"></textarea>
                    </div>
                </div>
                
                <!-- „Ç∑„Éº„É≥„Çø„Éñ -->
                <div class="page" data-page="1">
                    <div class="page-header">
                        <span>„Ç∑„Éº„É≥„Çø„Éñ</span>
                        <div class="desktop-buttons">
                            <button onclick="addScene()" class="desktop-button">„Ç∑„Éº„É≥ËøΩÂä†</button>
                        </div>
                    </div>
                    <div class="list-container" id="scenesContainer"></div>
                </div>
                
                <!-- „Éö„Éº„Ç∏„Çø„Éñ -->
                <div class="page" data-page="2">
                    <div class="page-header">
                        <span>„Éö„Éº„Ç∏„Çø„Éñ</span>
                        <div class="desktop-buttons">
                            <button onclick="addPage()" class="desktop-button">„Éö„Éº„Ç∏ËøΩÂä†</button>
                        </div>
                    </div>
                    <div class="list-container" id="pagesContainer"></div>
                </div>
                
                <!-- „Çª„É™„Éï„Çø„Éñ -->
                <div class="page" data-page="3">
                    <div class="page-header">
                        <span>„Çª„É™„Éï„Çø„Éñ</span>
                        <div class="desktop-buttons">
                            <button onclick="exportDialogues()" class="desktop-button">„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        </div>
                    </div>
                    <div class="list-container" id="dialoguesContainer"></div>
                </div>
            </div>
            
            <!-- „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
            <div class="page-indicators" id="pageIndicators">
                <span class="indicator active"></span>
                <span class="indicator"></span>
                <span class="indicator"></span>
                <span class="indicator"></span>
            </div>
        </div>
        
        <!-- „Çø„Éñ„Éê„ÉºÔºà„É¢„Éê„Ç§„É´Áî®Ôºâ -->
        <div class="tab-bar">
            <div class="tab-item active" data-page="0" onclick="switchToPage(0)">
                <span class="tab-icon">üìù</span>
                <span class="tab-label">„É°„Ç§„É≥</span>
            </div>
            <div class="tab-item" data-page="1" onclick="switchToPage(1)">
                <span class="tab-icon">üé¨</span>
                <span class="tab-label">„Ç∑„Éº„É≥</span>
            </div>
            <div class="tab-item" data-page="2" onclick="switchToPage(2)">
                <span class="tab-icon">üìÑ</span>
                <span class="tab-label">„Éö„Éº„Ç∏</span>
            </div>
            <div class="tab-item" data-page="3" onclick="switchToPage(3)">
                <span class="tab-icon">üí¨</span>
                <span class="tab-label">„Çª„É™„Éï</span>
            </div>
        </div>
        
        <!-- „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
        <button class="fab" id="fab" onclick="handleFabClick()">+</button>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentPage = 0;
        let data = {
            scenes: [],
            pages: [],
            dialogues: []
        };
        
        // DOMË¶ÅÁ¥†
        let mainEditor;
        let scenesContainer;
        let pagesContainer;
        let dialoguesContainer;
        let swiperContainer;
        let pageIndicators;
        let fab;
        let undoButton;
        let redoButton;
        
        // Â±•Ê≠¥ÁÆ°ÁêÜ
        let history = [];
        let historyIndex = -1;
        const maxHistory = 50;
        let isUpdatingFromHistory = false;
        
        // „Çπ„ÉØ„Ç§„ÉóÂà∂Âæ°
        let touchStartX = 0;
        let touchEndX = 0;
        let isSwiping = false;
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
            mainEditor = document.getElementById('mainEditor');
            scenesContainer = document.getElementById('scenesContainer');
            pagesContainer = document.getElementById('pagesContainer');
            dialoguesContainer = document.getElementById('dialoguesContainer');
            swiperContainer = document.getElementById('swiperContainer');
            pageIndicators = document.getElementById('pageIndicators');
            fab = document.getElementById('fab');
            undoButton = document.getElementById('undoButton');
            redoButton = document.getElementById('redoButton');
            
            // Â±•Ê≠¥„ÅÆÂàùÊúüÂåñ
            addToHistory(mainEditor.value);
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners();
            
            // ÂàùÊúüË°®Á§∫
            updateUI();
            updatePageIndicators();
            updateTabBar();
            updateFab();
        });
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // „ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„ÅÆ„Ç§„Éô„É≥„Éà
            let inputTimer = null;
            mainEditor.addEventListener('input', (e) => {
                updateUI();
                clearTimeout(inputTimer);
                inputTimer = setTimeout(() => {
                    addToHistory(mainEditor.value);
                }, 500);
            });
            
            // „Çπ„ÉØ„Ç§„Éó„Ç§„Éô„É≥„ÉàÔºà„É¢„Éê„Ç§„É´„ÅÆ„ÅøÔºâ
            if (window.innerWidth < 768) {
                swiperContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
                swiperContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
                swiperContainer.addEventListener('touchend', handleTouchEnd);
            }
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    e.preventDefault();
                    redo();
                }
            });
            
            // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    swiperContainer.style.transform = 'translateX(0)';
                } else {
                    switchToPage(currentPage);
                }
            });
        }
        
        // „Çπ„ÉØ„Ç§„Éó„Éè„É≥„Éâ„É©„Éº
        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            isSwiping = false;
        }
        
        function handleTouchMove(e) {
            if (!touchStartX) return;
            
            const touchX = e.touches[0].clientX;
            const diffX = touchX - touchStartX;
            
            if (Math.abs(diffX) > 10) {
                isSwiping = true;
            }
        }
        
        function handleTouchEnd(e) {
            if (!isSwiping) return;
            
            touchEndX = e.changedTouches[0].clientX;
            const diffX = touchEndX - touchStartX;
            
            // „Çπ„ÉØ„Ç§„Éó„ÅÆÂà§ÂÆöÔºà50px‰ª•‰∏ä„ÅßÂàá„ÇäÊõø„ÅàÔºâ
            if (Math.abs(diffX) > 50) {
                if (diffX > 0 && currentPage > 0) {
                    // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºàÂâç„ÅÆ„Éö„Éº„Ç∏„Å∏Ôºâ
                    switchToPage(currentPage - 1);
                } else if (diffX < 0 && currentPage < 3) {
                    // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºàÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å∏Ôºâ
                    switchToPage(currentPage + 1);
                }
            }
            
            touchStartX = 0;
            touchEndX = 0;
            isSwiping = false;
        }
        
        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        function switchToPage(pageIndex) {
            currentPage = pageIndex;
            const offset = -pageIndex * 100;
            swiperContainer.style.transform = `translateX(${offset}%)`;
            updatePageIndicators();
            updateTabBar();
            updateFab();
        }
        
        // „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÅÆÊõ¥Êñ∞
        function updatePageIndicators() {
            const indicators = pageIndicators.querySelectorAll('.indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === currentPage);
            });
        }
        
        // „Çø„Éñ„Éê„Éº„ÅÆÊõ¥Êñ∞
        function updateTabBar() {
            const tabs = document.querySelectorAll('.tab-item');
            tabs.forEach((tab, index) => {
                tab.classList.toggle('active', index === currentPage);
            });
        }
        
        // FAB„ÅÆÊõ¥Êñ∞
        function updateFab() {
            if (window.innerWidth >= 768) {
                fab.style.display = 'none';
                return;
            }
            
            // „É°„Ç§„É≥„Çø„Éñ„Åß„ÅØÈùûË°®Á§∫
            fab.style.display = currentPage === 0 ? 'none' : 'flex';
        }
        
        // FAB„ÇØ„É™„ÉÉ„ÇØ„Éè„É≥„Éâ„É©„Éº
        function handleFabClick() {
            switch (currentPage) {
                case 1:
                    addScene();
                    break;
                case 2:
                    addPage();
                    break;
                case 3:
                    exportDialogues();
                    break;
            }
        }
        
        // „Éï„Ç°„Ç§„É´„É°„Éã„É•„Éº„ÅÆË°®Á§∫
        function showFileMenu() {
            const menu = `
1. Êñ∞Ë¶è‰ΩúÊàê
2. „Éï„Ç°„Ç§„É´„ÇíÈñã„Åè
3. ‰øùÂ≠ò
4. „Çª„É™„Éï„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà

ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ:`;
            
            const choice = prompt(menu);
            
            switch (choice) {
                case '1':
                    newFile();
                    break;
                case '2':
                    openFile();
                    break;
                case '3':
                    saveFile();
                    break;
                case '4':
                    exportDialogues();
                    break;
            }
        }
        
        // Â±•Ê≠¥ÁÆ°ÁêÜ
        function addToHistory(text) {
            if (isUpdatingFromHistory) return;
            
            history = history.slice(0, historyIndex + 1);
            history.push(text);
            
            if (history.length > maxHistory) {
                history.shift();
            }
            
            historyIndex = history.length - 1;
            updateUndoRedoButtons();
        }
        
        function updateUndoRedoButtons() {
            const undoButtons = document.querySelectorAll('.undo-button');
            const redoButtons = document.querySelectorAll('.redo-button');
            
            undoButtons.forEach(btn => btn.disabled = historyIndex <= 0);
            redoButtons.forEach(btn => btn.disabled = historyIndex >= history.length - 1);
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                isUpdatingFromHistory = true;
                mainEditor.value = history[historyIndex];
                updateUI();
                isUpdatingFromHistory = false;
                updateUndoRedoButtons();
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                isUpdatingFromHistory = true;
                mainEditor.value = history[historyIndex];
                updateUI();
                isUpdatingFromHistory = false;
                updateUndoRedoButtons();
            }
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Éë„Éº„Çπ
        function parseText(text) {
            const newData = {
                scenes: [],
                pages: [],
                dialogues: []
            };
            
            // „Ç∑„Éº„É≥„ÅÆÊäΩÂá∫
            const sceneRegex = /\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g;
            let sceneMatch;
            let sceneIndex = 0;
            let globalPageNumber = 1;
            
            while ((sceneMatch = sceneRegex.exec(text)) !== null) {
                const sceneContent = sceneMatch[1];
                const sceneId = `scene-${sceneIndex}`;
                
                const sceneData = {
                    id: sceneId,
                    content: sceneContent,
                    fullMatch: sceneMatch[0],
                    startIndex: sceneMatch.index,
                    endIndex: sceneMatch.index + sceneMatch[0].length,
                    pages: []
                };
                
                // „Ç∑„Éº„É≥ÂÜÖ„ÅÆ„Éö„Éº„Ç∏„ÇíÊäΩÂá∫
                const pageRegex = /\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g;
                let pageMatch;
                
                while ((pageMatch = pageRegex.exec(sceneContent)) !== null) {
                    const pageContent = pageMatch[1];
                    const pageId = `page-${sceneIndex}-${sceneData.pages.length}`;
                    
                    // „Éö„Éº„Ç∏ÂÜÖ„ÅÆ„Çª„É™„Éï„ÇíÊäΩÂá∫
                    const dialogues = [];
                    const dialogueRegex = /„Äå([^„Äç]*)„Äç/g;
                    let dialogueMatch;
                    
                    while ((dialogueMatch = dialogueRegex.exec(pageContent)) !== null) {
                        dialogues.push(dialogueMatch[1]);
                    }
                    
                    const page = {
                        id: pageId,
                        content: pageContent,
                        sceneId: sceneId,
                        sceneIndex: sceneIndex,
                        dialogues: dialogues,
                        pageNumber: globalPageNumber++
                    };
                    
                    newData.pages.push(page);
                    sceneData.pages.push(page);
                    
                    // „Çª„É™„Éï„Çídialogues„Å´ËøΩÂä†
                    newData.dialogues.push({
                        pageId: pageId,
                        sceneId: sceneId,
                        texts: dialogues
                    });
                }
                
                newData.scenes.push(sceneData);
                sceneIndex++;
            }
            
            return newData;
        }
        
        // UIÊõ¥Êñ∞
        function updateUI() {
            const text = mainEditor.value;
            data = parseText(text);
            
            updateScenes();
            updatePages();
            updateDialogues();
        }
        
        // „Ç∑„Éº„É≥„ÅÆÊõ¥Êñ∞
        function updateScenes() {
            scenesContainer.innerHTML = '';
            
            if (data.scenes.length === 0) {
                scenesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üé¨</div>
                        <div>„Ç∑„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">+ „Éú„Çø„É≥„ÅßËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            data.scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'list-item scene-item';
                
                sceneItem.innerHTML = `
                    <div class="item-header">
                        <span class="item-label">„Ç∑„Éº„É≥ ${index + 1}</span>
                        <button class="item-delete" onclick="deleteScene(${index})">ÂâäÈô§</button>
                    </div>
                    <div class="item-content" contenteditable="true" data-index="${index}" data-type="scene">${escapeHtml(scene.content).replace(/\n/g, '<br>')}</div>
                `;
                
                // Á∑®ÈõÜ„Ç§„Éô„É≥„Éà
                const contentDiv = sceneItem.querySelector('.item-content');
                setupContentEditable(contentDiv, index, 'scene');
                
                scenesContainer.appendChild(sceneItem);
            });
        }
        
        // „Éö„Éº„Ç∏„ÅÆÊõ¥Êñ∞
        function updatePages() {
            pagesContainer.innerHTML = '';
            
            if (data.pages.length === 0) {
                pagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <div>„Éö„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">„Ç∑„Éº„É≥„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            let currentSceneId = null;
            
            data.pages.forEach((page, index) => {
                // „Ç∑„Éº„É≥Âå∫Âàá„Çä„ÇíË°®Á§∫
                if (page.sceneId !== currentSceneId) {
                    currentSceneId = page.sceneId;
                    const sceneIndex = data.scenes.findIndex(s => s.id === page.sceneId);
                    
                    const separator = document.createElement('div');
                    separator.style.padding = '8px 16px';
                    separator.style.color = '#666';
                    separator.style.fontSize = '14px';
                    separator.innerHTML = `<strong>„Ç∑„Éº„É≥ ${sceneIndex + 1}</strong>`;
                    pagesContainer.appendChild(separator);
                    
                    // „Éö„Éº„Ç∏ËøΩÂä†„Éú„Çø„É≥
                    const addButton = document.createElement('button');
                    addButton.className = 'header-button';
                    addButton.style.margin = '0 16px 12px';
                    addButton.style.background = '#17a2b8';
                    addButton.textContent = '+ „Åì„ÅÆ„Ç∑„Éº„É≥„Å´„Éö„Éº„Ç∏„ÇíËøΩÂä†';
                    addButton.onclick = () => addPageToScene(page.sceneId, sceneIndex);
                    pagesContainer.appendChild(addButton);
                }
                
                const pageItem = document.createElement('div');
                pageItem.className = 'list-item page-item';
                
                pageItem.innerHTML = `
                    <div class="item-header">
                        <span class="item-label">„Éö„Éº„Ç∏ ${page.pageNumber}</span>
                        <button class="item-delete" onclick="deletePage(${index})">ÂâäÈô§</button>
                    </div>
                    <div class="item-content" contenteditable="true" data-index="${index}" data-type="page">${escapeHtml(page.content).replace(/\n/g, '<br>')}</div>
                `;
                
                // Á∑®ÈõÜ„Ç§„Éô„É≥„Éà
                const contentDiv = pageItem.querySelector('.item-content');
                setupContentEditable(contentDiv, index, 'page');
                
                pagesContainer.appendChild(pageItem);
            });
        }
        
        // „Çª„É™„Éï„ÅÆÊõ¥Êñ∞
        function updateDialogues() {
            dialoguesContainer.innerHTML = '';
            
            if (data.dialogues.length === 0) {
                dialoguesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <div>„Çª„É™„Éï„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        <div style="font-size: 14px; margin-top: 8px;">„Éö„Éº„Ç∏„Å´„Äå„Äç„Åß„Çª„É™„Éï„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                `;
                return;
            }
            
            data.dialogues.forEach((dialogueGroup, index) => {
                if (dialogueGroup.texts.length === 0) return;
                
                const dialogueItem = document.createElement('div');
                dialogueItem.className = 'list-item dialogue-item';
                
                const page = data.pages.find(p => p.id === dialogueGroup.pageId);
                
                dialogueItem.innerHTML = `
                    <div class="item-header">
                        <span class="item-label">„Éö„Éº„Ç∏ ${page ? page.pageNumber : '?'}</span>
                    </div>
                    <div class="item-content">
                        ${dialogueGroup.texts.map(text => `<div class="dialogue-text">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`).join('')}
                    </div>
                `;
                
                dialoguesContainer.appendChild(dialogueItem);
            });
        }
        
        // „Ç≥„É≥„ÉÜ„É≥„ÉÑÁ∑®ÈõÜÂèØËÉΩË¶ÅÁ¥†„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        function setupContentEditable(element, index, type) {
            let isComposing = false;
            
            element.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            element.addEventListener('compositionend', () => {
                isComposing = false;
            });
            
            element.addEventListener('input', (e) => {
                if (!isComposing) {
                    const newContent = htmlToText(e.target.innerHTML);
                    if (type === 'scene') {
                        updateSceneContent(index, newContent, false);
                    } else if (type === 'page') {
                        updatePageContent(index, newContent, false);
                    }
                }
            });
            
            element.addEventListener('blur', (e) => {
                const newContent = htmlToText(e.target.innerHTML);
                if (type === 'scene') {
                    updateSceneContent(index, newContent, true);
                } else if (type === 'page') {
                    updatePageContent(index, newContent, true);
                }
                addToHistory(mainEditor.value);
            });
            
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.execCommand('insertLineBreak');
                }
            });
        }
        
        // „Ç∑„Éº„É≥ÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
        function updateSceneContent(index, newContent, shouldUpdateUI = true) {
            const text = mainEditor.value;
            const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
            
            if (scenes[index]) {
                const oldScene = scenes[index][0];
                const oldContent = scenes[index][1];
                const trimmedOldContent = oldContent.replace(/\n+$/, '');
                const trimmedNewContent = newContent.replace(/\n+$/, '');
                const trailingNewlines = oldContent.match(/\n*$/)[0];
                const newScene = oldScene.replace(oldContent, trimmedNewContent + trailingNewlines);
                
                mainEditor.value = text.replace(oldScene, newScene);
                if (shouldUpdateUI) {
                    updateUI();
                }
            }
        }
        
        // „Éö„Éº„Ç∏ÂÜÖÂÆπ„ÅÆÊõ¥Êñ∞
        function updatePageContent(index, newContent, shouldUpdateUI = true) {
            const text = mainEditor.value;
            const allPages = [...text.matchAll(/\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g)];
            
            let pageCount = 0;
            for (let match of allPages) {
                if (pageCount === index) {
                    const oldPage = match[0];
                    const oldContent = match[1];
                    const trimmedOldContent = oldContent.replace(/\n+$/, '');
                    const trimmedNewContent = newContent.replace(/\n+$/, '');
                    const trailingNewlines = oldContent.match(/\n*$/)[0];
                    const newPage = oldPage.replace(oldContent, trimmedNewContent + trailingNewlines);
                    
                    mainEditor.value = text.replace(oldPage, newPage);
                    if (shouldUpdateUI) {
                        updateUI();
                    }
                    break;
                }
                pageCount++;
            }
        }
        
        // „Ç∑„Éº„É≥„ÅÆÂâäÈô§
        function deleteScene(index) {
            if (confirm('„Åì„ÅÆ„Ç∑„Éº„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const text = mainEditor.value;
                const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
                
                if (scenes[index]) {
                    mainEditor.value = text.replace(scenes[index][0], '');
                    updateUI();
                    addToHistory(mainEditor.value);
                }
            }
        }
        
        // „Éö„Éº„Ç∏„ÅÆÂâäÈô§
        function deletePage(index) {
            if (confirm('„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                const text = mainEditor.value;
                const allPages = [...text.matchAll(/\[„Éö„Éº„Ç∏:\s*([^\]]*)\]/g)];
                
                let pageCount = 0;
                for (let match of allPages) {
                    if (pageCount === index) {
                        mainEditor.value = text.replace(match[0], '');
                        break;
                    }
                    pageCount++;
                }
                updateUI();
                addToHistory(mainEditor.value);
            }
        }
        
        // „Ç∑„Éº„É≥„ÅÆËøΩÂä†
        function addScene() {
            const newScene = '\n\n{„Ç∑„Éº„É≥: Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥\n[„Éö„Éº„Ç∏: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏\n„Äå„Çª„É™„Éï„Äç\n]\n}';
            mainEditor.value += newScene;
            updateUI();
            addToHistory(mainEditor.value);
        }
        
        // „Éö„Éº„Ç∏„ÅÆËøΩÂä†
        function addPage() {
            const newScene = '\n\n{„Ç∑„Éº„É≥: Êñ∞„Åó„ÅÑ„Ç∑„Éº„É≥\n[„Éö„Éº„Ç∏: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏\n„Äå„Çª„É™„Éï„Äç\n]\n}';
            mainEditor.value += newScene;
            updateUI();
            addToHistory(mainEditor.value);
        }
        
        // ÁâπÂÆö„ÅÆ„Ç∑„Éº„É≥„Å´„Éö„Éº„Ç∏„ÇíËøΩÂä†
        function addPageToScene(sceneId, sceneIndex) {
            const text = mainEditor.value;
            const scenes = [...text.matchAll(/\{„Ç∑„Éº„É≥:\s*([^}]*)\}/g)];
            
            if (scenes[sceneIndex]) {
                const sceneMatch = scenes[sceneIndex];
                const sceneContent = sceneMatch[0];
                const newPage = '\n[„Éö„Éº„Ç∏: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏\n„Äå„Çª„É™„Éï„Äç\n]';
                const newSceneContent = sceneContent.replace(/\}$/, newPage + '\n}');
                
                mainEditor.value = text.replace(sceneContent, newSceneContent);
                updateUI();
                addToHistory(mainEditor.value);
            }
        }
        
        // „Çª„É™„Éï„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportDialogues() {
            const allDialogues = [];
            data.dialogues.forEach(group => {
                allDialogues.push(...group.texts);
            });
            
            const dialogueText = allDialogues.join('\n\n');
            const blob = new Blob([dialogueText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dialogues.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // „Éï„Ç°„Ç§„É´Êìç‰Ωú
        let currentFileName = null;
        
        function newFile() {
            if (mainEditor.value && !confirm('ÁèæÂú®„ÅÆÂÜÖÂÆπ„ÇíÁ†¥Ê£Ñ„Åó„Å¶Êñ∞Ë¶è‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü')) {
                return;
            }
            mainEditor.value = '';
            currentFileName = null;
            history = [''];
            historyIndex = 0;
            updateUI();
            updateUndoRedoButtons();
        }
        
        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        mainEditor.value = e.target.result;
                        currentFileName = file.name;
                        history = [e.target.result];
                        historyIndex = 0;
                        updateUI();
                        updateUndoRedoButtons();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function saveFile() {
            const text = mainEditor.value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName || 'treescript-document.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function htmlToText(html) {
            let text = html.replace(/<br\s*\/?>/gi, '\n');
            text = text.replace(/<[^>]*>/g, '');
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
    </script>
</body>
</html>